import{_ as t,r as o,c as e,a,e as r,g as s,v as l,t as n,m as i,p as c,o as u}from"./index.DcWu3WZk.js";import"./data.DmP2Cwku.js";import{addFeishuRecord as p}from"./feishuApi.C5khGGHD.js";const m=""+new URL("reward.BNgf-p5R.png",import.meta.url).href,d=""+new URL("882269822396564_1764237444705701185.tif~tplv-e1ww11ta6z-normal.B-PqxACl.png",import.meta.url).href,f={class:"import-dishes"},g={class:"new-container"},v={class:"container-image"},h={class:"input-container"},w={key:0,class:"macaron-modal"},y={class:"modal-content"},_={class:"modal-text"},U={key:1,class:"loading-modal"},j=t({__name:"index",setup(t){const j=o(""),k=o(!1),A=o(""),R=o(!1),S=async()=>{if(!j.value.trim())return;R.value=!0;const t=j.value.trim();if(await $(t))k.value=!0,A.value="小主！这道菜御膳房已经备了！",R.value=!1;else try{console.log("调用扣子工作流，发送消息:",t);const e=await(async t=>{for(let a=0;a<3;a++)try{const e=await c();if(!e||!e.trim())throw new Error("无效的Coze API密钥");const r={workflow_id:"7576228389498798116",parameters:{USER_INPUT:t}};console.log(`调用扣子工作流 (第${a+1}次尝试)，发送请求:`,r);const s="https://api.coze.cn/v1/workflow/run";console.log("直接调用 Coze API，URL:",s);const l=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!l.ok){const t=await l.json().catch(()=>({}));throw new Error(`HTTP error! status: ${l.status} - ${JSON.stringify(t)}`)}const n=await l.json();if(console.log("扣子工作流API响应:",JSON.stringify(n,null,2)),0!==n.code)throw new Error(`工作流执行失败: ${n.msg||"未知错误"}`);if(n.data)try{const t=JSON.parse(n.data);if(console.log("解析后的数据:",t),t.output)return console.log("扣子工作流返回结果:",t.output),t}catch(o){console.error("解析 data 字段失败:",o),console.error("原始 data 字段:",n.data)}throw new Error("未找到工作流输出结果")}catch(e){if(console.error(`调用扣子工作流失败 (第${a+1}次尝试):`,e),2===a)throw e;await new Promise(t=>setTimeout(t,1500))}})(t);if(e&&e.output){const t=e.output;console.log("工作流返回的原始数据:",t);const a=t.map(t=>{const o=t.split(",");if(o.length<4)return console.error("无效的菜品数据格式（期望4个字段）:",t),null;const e=o[0].trim(),a=o[1].trim(),r=o[2].trim();let s=o[3].trim();if("object"==typeof s&&null!==s)if(s.link)s=s.link;else if(s.url)s=s.url;else if(s.uri)s=s.uri;else if(Array.isArray(s)&&s[0]){const t=s[0];s="object"==typeof t&&null!==t?t.link||t.url||t.uri||"":String(t)}else{const t=JSON.stringify(s).match(/https?:\/\/[^"\'\s\}]+/);s=t?t[0]:""}s=String(s),s=s.trim(),s=s.replace(/[\s"'<>]/g,"");const l=/^(http|https):\/\//i;l.test(s)||(console.error("无效的URL格式，缺少协议头，使用默认图片URL:",s),s="https://via.placeholder.com/200x200?text=No+Image"),console.log("处理后的URL:",s),console.log("URL是否包含有效的协议头:",l.test(s));return{name:r,category:e,subCategory:a,ingredients:[r],description:`${e} - ${a} - ${r}`,imageUrl:String(s)}}).filter(t=>null!==t);console.log("转换后的菜品数据:",a);let r=0;for(const e of a)try{await p(e),r++}catch(o){console.error("添加到飞书表格失败:",o)}r>0?(console.log(`成功将 ${r} 道菜品添加到飞书表格`),k.value=!0,A.value="小主，新菜菜已经入库啦！",j.value=""):(console.log("没有添加新菜品到飞书表格"),k.value=!0,A.value="小主，添加菜品到飞书表格失败！")}}catch(o){console.error("处理扣子工作流结果失败:",o),k.value=!0,A.value="小主，网络有点不给力，稍后再试试吧！"}finally{R.value=!1}},$=async t=>{if(!t)return!1;const o=t=>t.toLowerCase().replace(/[炖煮炒炸烧焖煎烤蒸烩拌]/g," ").split("").sort().join(""),e=o(t);try{const t=await i(()=>import("./feishuApi.C5khGGHD.js"),[],import.meta.url).then(t=>t.getFeishuDishes());for(const a of t){if(e===o(a.name))return!0}}catch(a){console.error("从飞书表格获取数据失败:",a)}return!1};return(t,o)=>(u(),e("div",f,[a("div",g,[a("div",v,[o[2]||(o[2]=a("img",{class:"bg-image",src:m,alt:"悬赏图片"},null,-1)),a("div",h,[s(a("input",{type:"text",class:"center-input",placeholder:"小主想吃啥？","onUpdate:modelValue":o[0]||(o[0]=t=>j.value=t)},null,512),[[l,j.value]])]),a("div",{class:"icon-container"},[a("img",{class:"input-icon",src:d,alt:"输入框图标",onClick:S})])])]),k.value?(u(),e("div",w,[a("div",y,[a("div",_,n(A.value),1),a("button",{class:"modal-btn",onClick:o[1]||(o[1]=t=>k.value=!1)},"准了")])])):r("",!0),R.value?(u(),e("div",U,[...o[3]||(o[3]=[a("div",{class:"loading-content"},[a("div",{class:"loading-spinner"}),a("div",{class:"loading-text"},"正在准备小主的菜肴...")],-1)])])):r("",!0)]))}},[["__scopeId","data-v-f907387f"]]);export{j as default};
