const e={baseUrl:"/api/feishu/open-apis",appId:"cli_a9ae903f207bdbcb",appSecret:"DLR7udnlQ8uDfyU9DPNhVeV1F6xKZoLs",dishes:{appToken:"V5CFbM5fZaCJRBsviBucYxnxnEe",tableId:"tblg1qsIFjb2tazd"},orders:{appToken:"V5CFbM5fZaCJRBsviBucYxnxnEe",tableId:"tbltx7SbCt4HwzzO",viewId:"veweKgyGVi"}},t="qingqing_feishu_dishes",r=864e5;async function o(){try{const r=`${e.baseUrl}/auth/v3/tenant_access_token/internal`,o=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"},body:JSON.stringify({app_id:e.appId,app_secret:e.appSecret})}),a=await o.text();if(!o.ok)throw new Error(`获取飞书访问令牌失败: ${o.status} - ${a}`);let n;try{n=JSON.parse(a)}catch(t){throw console.error("解析飞书API响应JSON失败:",t),new Error(`解析飞书API响应JSON失败: ${t.message} - 原始响应: ${a}`)}if(0!==n.code)throw new Error(`飞书API错误: ${n.msg}`);return n.tenant_access_token}catch(r){throw console.error("获取飞书访问令牌错误:",r),r}}async function a(t,r="dishes"){try{const a=e[r];if(!a)throw new Error(`未知的表格类型: ${r}`);const n=`${e.baseUrl}/bitable/v1/apps/${a.appToken}/tables/${a.tableId}/records`,s=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"}}),i=await s.text();if(!s.ok)throw new Error(`获取飞书表格数据失败: ${s.status} - ${i}`);let c;try{c=JSON.parse(i),console.log(`getFeishuTableData API响应 (${r}):`,JSON.stringify(c,null,2))}catch(o){throw console.error("解析飞书API响应JSON失败:",o),new Error(`解析飞书API响应JSON失败: ${o.message} - 原始响应: ${i}`)}if(0!==c.code)throw new Error(`飞书API错误: ${c.msg}`);if(c.data.records)return c.data.records;if(c.data.items)return c.data.items;throw new Error("飞书API响应中没有找到记录数据")}catch(a){throw console.error("获取飞书表格数据错误:",a),a}}function n(e){return e.map((e,t)=>{const r=e.fields;let o=r.url||"";try{if("string"!=typeof o)if(console.log("检测到非字符串URL:",o,"类型:",typeof o),o&&"object"==typeof o)if(o.link)o=o.link;else if(o.url)o=o.url;else if(o.uri)o=o.uri;else if(Array.isArray(o)){const e=o[0];o=e&&"object"==typeof e?e.link||e.url||e.uri||"":e?String(e):""}else{o=JSON.stringify(o);const e=o.match(/https?:\/\/[^"\'\s\}]+/);o=e?e[0]:""}else o=String(o);o&&(o=o.replace(/^["\']|["\']$/g,""),o.startsWith("http")||(console.error("无效的URL格式，已重置为空:",o),o=""))}catch(a){console.error("处理URL时发生错误:",a),o=""}return{id:`dish-${String(t+1).padStart(4,"0")}`,name:r["菜肴名称"]||"",category:r["一级分类"]||"",subCategory:r["二级分类"]||"",ingredients:[r["二级分类"]||""],imageUrl:o,price:"一个亲亲"}})}function s(){try{const e=localStorage.getItem(t);if(!e)return null;const{data:o,timestamp:a}=JSON.parse(e);return Date.now()-a>r?(localStorage.removeItem(t),null):o}catch(e){return console.error("从缓存获取数据错误:",e),localStorage.removeItem(t),null}}function i(e){try{const r={data:e,timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(r))}catch(r){console.error("缓存数据错误:",r)}}async function c(){const e=s();if(e)return console.log("使用缓存的菜肴数据"),e;try{const e=await o(),t=n(await a(e));return i(t),console.log(`从飞书获取 ${t.length} 条菜肴数据`),t}catch(t){return console.error("获取飞书菜肴数据错误:",t),[]}}async function l(){try{const e=await o();console.log("获取最新的飞书表格数据...");const t=await a(e);if(!t||0===t.length)return console.log("飞书表格没有数据"),null;let r="";for(const o of t)o.update_time&&o.update_time>r&&(r=o.update_time);return console.log(`飞书表格最近修改时间: ${r}`),r}catch(e){return console.error("获取飞书表格最近修改时间错误:",e),null}}async function h(t){try{const a=await o(),n={fields:{"一级分类":t.category||"","二级分类":t.subCategory||"","菜肴名称":t.name||"",url:{link:t.imageUrl||"",text:t.name||"无标题"}}};console.log("飞书API请求URL:",`${e.baseUrl}/bitable/v1/apps/${e.dishes.appToken}/tables/${e.dishes.tableId}/records`),console.log("飞书API请求头:",{Authorization:`Bearer ${a}`,"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"}),console.log("飞书API请求体:",JSON.stringify(n,null,2));const s=`${e.baseUrl}/bitable/v1/apps/${e.dishes.appToken}/tables/${e.dishes.tableId}/records`,i=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"},body:JSON.stringify(n)}),c=await i.text();if(console.log("飞书API响应状态:",i.status),console.log("飞书API响应内容:",c),!i.ok)throw new Error(`添加飞书记录失败: ${i.status} - ${c}`);let l;try{l=JSON.parse(c),console.log("飞书API响应JSON:",JSON.stringify(l,null,2))}catch(r){throw console.error("解析飞书API响应JSON失败:",r),new Error(`解析飞书API响应JSON失败: ${r.message} - 原始响应: ${c}`)}if(0!==l.code)throw new Error(`飞书API错误: ${l.msg} - 请求ID: ${l.request_id||"未知"}`);return console.log("成功向飞书表格添加记录:",l),l}catch(a){throw console.error("向飞书表格添加记录失败:",a),a}}async function d(){return localStorage.removeItem(t),await c()}async function g(){try{const e=await o(),t=(await a(e,"orders")).map((e,t)=>{const r=e.fields;let o=r["创建时间"]||"",a="";if(o)try{const e=new Date(o);if(isNaN(e.getTime())){o=(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),a=o}else a=e.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),o=e.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"})}catch(n){console.error("转换创建时间失败:",n);o=(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),a=o}else{o=(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),a=o}return{id:e.id||`order-${t}`,name:r["菜品名称"]||"",createTime:o,status:r["订单状态"]||"待处理",time:a}});return console.log(`从飞书获取 ${t.length} 条订单数据`),t}catch(e){return console.error("获取飞书订单数据错误:",e),[]}}async function p(t,r){try{const n=await o(),s={fields:{"订单状态":r}},i=e.orders,c=`${e.baseUrl}/bitable/v1/apps/${i.appToken}/tables/${i.tableId}/records/${t}`,l=await fetch(c,{method:"PUT",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"},body:JSON.stringify(s)}),h=await l.text();if(!l.ok)throw new Error(`更新飞书订单状态失败: ${l.status} - ${h}`);let d;try{d=JSON.parse(h)}catch(a){throw new Error(`解析飞书API响应JSON失败: ${a.message} - 原始响应: ${h}`)}if(0!==d.code)throw new Error(`飞书API错误: ${d.msg}`);return console.log(`成功更新订单状态: ${t} -> ${r}`),d}catch(n){throw console.error("更新飞书订单状态错误:",n),n}}async function u(t){try{const a=await o(),n={fields:{"创建时间":t.createTime?String(t.createTime):(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),"菜品名称":t.name||"","订单状态":t.status||"待处理"}},s=e.orders,i=`${e.baseUrl}/bitable/v1/apps/${s.appToken}/tables/${s.tableId}/records`,c=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json","User-Agent":"Node.js/24.11.1"},body:JSON.stringify(n)}),l=await c.text();if(!c.ok)throw new Error(`添加飞书订单失败: ${c.status} - ${l}`);let h;try{h=JSON.parse(l)}catch(r){throw new Error(`解析飞书API响应JSON失败: ${r.message} - 原始响应: ${l}`)}if(0!==h.code)throw new Error(`飞书API错误: ${h.msg}`);return console.log(`成功添加飞书订单: ${h.data.record.id}`),h.data.record}catch(a){throw console.error("添加飞书订单错误:",a),a}}export{u as addFeishuOrder,h as addFeishuRecord,i as cacheDishes,n as convertFeishuDataToDishData,s as getCachedDishes,o as getFeishuAccessToken,c as getFeishuDishes,g as getFeishuOrders,a as getFeishuTableData,l as getFeishuTableUpdateTime,d as refreshFeishuDishes,p as updateFeishuOrderStatus};
