import{_ as t,r as o,c as e,a as s,e as a,g as r,v as n,t as l,m as i,p as c,o as u}from"./index.BVExK2gq.js";import"./data.DmP2Cwku.js";import{addFeishuRecord as p}from"./feishuApi.C5khGGHD.js";const g={class:"import-dishes"},d={class:"new-container"},f={class:"container-image"},m={class:"input-container"},v={key:0,class:"macaron-modal"},h={class:"modal-content"},w={class:"modal-text"},y={key:1,class:"loading-modal"},_=t({__name:"index",setup(t){const _=o(""),j=o(!1),k=o(""),A=o(!1),S=async()=>{if(!_.value.trim())return;A.value=!0;const t=_.value.trim();if(await $(t))j.value=!0,k.value="小主！这道菜御膳房已经备了！",A.value=!1;else try{console.log("调用扣子工作流，发送消息:",t);const e=await(async t=>{for(let s=0;s<3;s++)try{const e=await c();if(!e||!e.trim())throw new Error("无效的Coze API密钥");const a={workflow_id:"7576228389498798116",parameters:{USER_INPUT:t}};console.log(`调用扣子工作流 (第${s+1}次尝试)，发送请求:`,a);const r="https://api.coze.cn/v1/workflow/run";console.log("直接调用 Coze API，URL:",r);const n=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok){const t=await n.json().catch(()=>({}));throw new Error(`HTTP error! status: ${n.status} - ${JSON.stringify(t)}`)}const l=await n.json();if(console.log("扣子工作流API响应:",JSON.stringify(l,null,2)),0!==l.code)throw new Error(`工作流执行失败: ${l.msg||"未知错误"}`);if(l.data)try{const t=JSON.parse(l.data);if(console.log("解析后的数据:",t),t.output)return console.log("扣子工作流返回结果:",t.output),t}catch(o){console.error("解析 data 字段失败:",o),console.error("原始 data 字段:",l.data)}throw new Error("未找到工作流输出结果")}catch(e){if(console.error(`调用扣子工作流失败 (第${s+1}次尝试):`,e),2===s)throw e;await new Promise(t=>setTimeout(t,1500))}})(t);if(e&&e.output){const t=e.output;console.log("工作流返回的原始数据:",t);const s=t.map(t=>{const o=t.split(",");if(o.length<4)return console.error("无效的菜品数据格式（期望4个字段）:",t),null;const e=o[0].trim(),s=o[1].trim(),a=o[2].trim();let r=o[3].trim();if("object"==typeof r&&null!==r)if(r.link)r=r.link;else if(r.url)r=r.url;else if(r.uri)r=r.uri;else if(Array.isArray(r)&&r[0]){const t=r[0];r="object"==typeof t&&null!==t?t.link||t.url||t.uri||"":String(t)}else{const t=JSON.stringify(r).match(/https?:\/\/[^"\'\s\}]+/);r=t?t[0]:""}r=String(r),r=r.trim(),r=r.replace(/[\s"'<>]/g,"");const n=/^(http|https):\/\//i;n.test(r)||(console.error("无效的URL格式，缺少协议头，使用默认图片URL:",r),r="https://via.placeholder.com/200x200?text=No+Image"),console.log("处理后的URL:",r),console.log("URL是否包含有效的协议头:",n.test(r));return{name:a,category:e,subCategory:s,ingredients:[a],description:`${e} - ${s} - ${a}`,imageUrl:String(r)}}).filter(t=>null!==t);console.log("转换后的菜品数据:",s);let a=0;for(const e of s)try{await p(e),a++}catch(o){console.error("添加到飞书表格失败:",o)}a>0?(console.log(`成功将 ${a} 道菜品添加到飞书表格`),j.value=!0,k.value="小主，新菜菜已经入库啦！",_.value=""):(console.log("没有添加新菜品到飞书表格"),j.value=!0,k.value="小主，添加菜品到飞书表格失败！")}}catch(o){console.error("处理扣子工作流结果失败:",o),j.value=!0,k.value="小主，网络有点不给力，稍后再试试吧！"}finally{A.value=!1}},$=async t=>{if(!t)return!1;const o=t=>t.toLowerCase().replace(/[炖煮炒炸烧焖煎烤蒸烩拌]/g," ").split("").sort().join(""),e=o(t);try{const t=await i(()=>import("./feishuApi.C5khGGHD.js"),[]).then(t=>t.getFeishuDishes());for(const s of t){if(e===o(s.name))return!0}}catch(s){console.error("从飞书表格获取数据失败:",s)}return!1};return(t,o)=>(u(),e("div",g,[s("div",d,[s("div",f,[o[2]||(o[2]=s("img",{class:"bg-image",src:"/qingqing/assets/reward.BNgf-p5R.png",alt:"悬赏图片"},null,-1)),s("div",m,[r(s("input",{type:"text",class:"center-input",placeholder:"小主想吃啥？","onUpdate:modelValue":o[0]||(o[0]=t=>_.value=t)},null,512),[[n,_.value]])]),s("div",{class:"icon-container"},[s("img",{class:"input-icon",src:"/qingqing/assets/882269822396564_1764237444705701185.tif~tplv-e1ww11ta6z-normal.B-PqxACl.png",alt:"输入框图标",onClick:S})])])]),j.value?(u(),e("div",v,[s("div",h,[s("div",w,l(k.value),1),s("button",{class:"modal-btn",onClick:o[1]||(o[1]=t=>j.value=!1)},"准了")])])):a("",!0),A.value?(u(),e("div",y,[...o[3]||(o[3]=[s("div",{class:"loading-content"},[s("div",{class:"loading-spinner"}),s("div",{class:"loading-text"},"正在准备小主的菜肴...")],-1)])])):a("",!0)]))}},[["__scopeId","data-v-f907387f"]]);export{_ as default};
